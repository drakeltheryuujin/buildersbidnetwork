<%= form_for [@project, @bid] do |f| %>
  <div class="row">
    <% if @bid.errors.any? %>
      <div class="alert-message block-message error">
        <strong><%= pluralize(@bid.errors.count, "error") %> prohibited this bid from being saved:</strong>

        <ul>
        <% @bid.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
        </ul>
      </div>
    <% end %>
    
    <%= render 'projects/meta' %>
  </div>
    
  <div class="row form-stacked">
    <label class="">Line Items</label>
    <ul class="span16 line_items">
      <%= f.fields_for :line_item_bids do |line_item_bid_form| %>
        <li class="line_item <%= cycle("odd", "even") %>">
          <%= line_item_bid_form.hidden_field :line_item_id %>
          <span class="content"><%= line_item_bid_form.object.line_item.content %></span>
          <span class="units">
            <% if ! line_item_bid_form.object.line_item.units.nil? %>
              <span class="line_item_units"><%= line_item_bid_form.object.line_item.units %></span>
              x $<%= line_item_bid_form.text_field :unit_cost, :value => number_with_precision(line_item_bid_form.object.unit_cost, :precision => 2), :size => 5, :placeholder => 'Unit Cost', :class => 'line_item_unit_cost span2' %>
              $<%= line_item_bid_form.text_field :cost, :value => number_with_precision(line_item_bid_form.object.cost, :precision => 2), :size => 10, :placeholder => 'Cost', :readonly => 'true', :class => 'line_item_cost calculated_line_item_cost span2' %>
            <% else %>
              $<%= line_item_bid_form.text_field :cost, :value => number_with_precision(line_item_bid_form.object.cost, :precision => 2), :size => 10, :placeholder => 'Cost', :class => 'line_item_cost span2' %>
            <% end %>
          </span>
        </li>
      <% end %>
    </ul>
  </div>

  <div class="row ">
    <div class="field float_right">
      <%= f.label :total %>
      $<%= f.text_field :total, :value => number_with_precision(f.object.total, :precision => 2), :id => 'bid_total', :size => 10, :readonly => 'true' %>
    </div>
  </div>
  
  <div class="row">
    <%= f.submit :class => 'float_right btn primary large' %>
  </div>
<% end %>
<% content_for :javascript do %>
  <%= javascript_include_tag "jquery.calculation" %>
  <script type="text/javascript">
    $(document).ready(function() {
      $("input.line_item_cost").sum({
        bind: "keyup",
        selector: "#bid_total",
        oncalc: function(value, settings) {
            $(settings.selector).val(value.toFixed(2));
        }
      });
      
      $("input.line_item_unit_cost").bind("keyup", recalc);
      function recalc(event) {
        $('.calculated_line_item_cost').calc(
          "units * cost", { 
            units: $(".line_item_units"),
            cost: $(".line_item_unit_cost") 
          }, 
          function (s){ 
            return s.toFixed(2); 
          }, 
          function ($this){ 
            var sum = $("input.line_item_cost").sum(); 
            $("#bid_total").text( sum.toFixed(2) ); 
          } 
        );
      }
    });
  </script>
<% end %>
